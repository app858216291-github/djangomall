{% extends 'base.html' %}
{% load static %}
{% block title %} {{ product.title }}-DJMall商城系统！ {% endblock %}
{% block head %}
<meta name="description" content="{{ product.desc }}">
<meta name="keywords" content="{{ product.sub_title }}">

{% endblock %}
{% block head_style %}
<style>
    /* 在填充数据之前隐藏 */
    [v-cloak] {
        display: none !important;
    }
    .is-active .al img {
        filter: grayscale(0%);
    }
    .al img {
        filter: grayscale(70%);
        /* width: 72px; */
        /* border: 2px solid transparent; */
    }
    /* .al img:hover {
        border-color: rgb(91, 8, 129);
    } */
</style>
<link rel="stylesheet" href="{% static 'product/css/product.css' %}"> 

{% endblock %} 

{% block main %}
<div id="slider-image" style="display: none;">{{ slider_image }}</div> 
<section class="section" id="product-detail" v-cloak>
    <div class="container">
        <div class="columns">
            <div class="column is-10">
                <div class="columns">
                    <!-- 商品banner -->
                    <div class="column is-4">
                        <div class="box is-paddingless">
                            <template>
                                <b-carousel :indicator-inside="false">
                                    <b-carousel-item v-for="(item, i) in slider" :key="i">
                                        <b-image class="image is-1by1" :src="item"></b-image>
                                    </b-carousel-item>
                                    <template #indicators="props">
                                        <b-image 
                                            class="al" 
                                            custom-class="al-image" 
                                            :src="getImgUrl(slider[props.i])"></b-image>
                                    </template>
                                </b-carousel>
                            </template>
                        </div>
                        
                        <section>
                            banner下
                        </section>
                    </div>
                    <!-- 商品banner end -->
                    <div class="column">
                        <h1 class="title is-size-4">{{ product.title }}</h1>
                        <h2 class="subtitle is-size-6">{{ product.sub_title }}</h2>
                        <!-- 商品价格区块 -->
                        <div class="money-wrapper has-background-primary">
                            <div class="good-price">
                                <div class="pl-5 is-pulled-left">
                                    <nav class="level">
                                        <div class="level-item has-text-left">
                                          <div class="mt-1">
                                                <p class="pl-2 heading sell-price">
                                                    原价：￥[[ market_price ]]</p>
                                                <p class="title has-text-white">￥[[ sell_price ]] </p>
                                          </div>
                                        </div>
                                      </nav>
                                </div>
                                <div class="pr-5 is-pulled-right">
                                    <nav class="level">
                                        <div class="level-item has-text-centered">
                                          <div class="pl-5 mt-3 sales-border">
                                            <p class="is-size-5 has-text-white">[[ sales ]]</p>
                                            <p class="heading">销量</p>
                                          </div>
                                        </div>
                                    </nav>
                                </div>
                                <div class=" is-clearfix"></div>
                            </div>

                        </div>
                        <!-- 商品价格区块 end -->
                        <div class="box is-radiusless">

                            <!-- 商品规格 -->
                            <div class="spec-sku mb-5 ">
                                <div id="data" style="display: none;">
                                    <div id="specs">{{ spec_json }} </div>
                                    <div id="spec-sku">{{ spec_sku_json }}</div>
                                    <div id="keys">{{ current_sku }}</div>
                                </div>
                                <div v-for="(item, index) in productAttr" :key="index" style="line-height: 2.5em;">
                                    <div class="is-size is-pulled-left mr-4">[[ item.name ]]:</div>
                                    <div class="acea-row list">
                                        <label v-for="(itm, idx) in item.attr_values" :key="idx" class="mr-2">
                                            <input v-model="attrSelected[index]" type="radio" :name="index" :value="itm" :checked="!idx" hidden />
                                            <span class="pt-1 pb-1 pl-4 pr-4 attr">[[ itm ]]</span>
                                        </label>
                                        <div class="is-clearfix"></div>
                                    </div>
                                    <div class="is-clearfix"></div>
                                </div>
                            </div>
                            <!-- 商品规格 end-->

                            <!-- 商品数量操作 -->
                            <template>
                                <div class="level mt-4">
                                    <div class="level-left">
                                        <label for="">数量：</label>
                                        <b-field style="position: relative; top:5px">
                                            <b-numberinput controls-position="compact" min="1" :max="stock" v-model="num" size="is-small">
                                            </b-numberinput> 
                                        </b-field>
                                        <span class="level-item ml-3 is-size-7">库存：[[ stock ]]箱</span>
                                    </div>
                                </div>
                            </template>
                            <!-- 商品数量操作 end -->

                            <div class="buttons">
                                <b-button type="is-primary" :disabled="!stock">加入购物车</b-button>
                                <b-button type="is-primary is-light" :disabled="!stock">立即购买</b-button>
                            </div>
                        </div>

                        <div class="box">
                            <template>
                                <section>
                                    <b-tabs class="block">
                                        <b-tab-item label="商品详情">
                                            <div class="content">
                                                {{ product.content|safe }}
                                            </div>
                                        </b-tab-item>
                                        <b-tab-item label="商品评价">商品评价</b-tab-item>
                                        <b-tab-item label="售后保障">{{ product.after_services }}</b-tab-item>
                                    </b-tabs>
                        
                                </section>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <div class="column">
                <div class="card is-shadowless">
                    <header class="card-header">
                      <p class="card-header-title is-centered">
                        新品推荐
                      </p>
                    </header>
                    <div class="card-content">
                    {% for product_dict in product_news %}
                      {% for spu, sku in product_dict.items  %}

                    <a href="{% url 'product:goods_detail' spu.id %}" class="mb-3">
                        <figure class="image is-square">
                            <img src="{{ MEDIA_URL }}{{ spu.main_picture }}" alt="{{ spu.title }}">
                        </figure>
                        <h1 class="pt-3 pb-1 has-text-weight-medium is-size-4 has-text-danger-dark is-family-primary">
                            ¥{{ sku.sell_price }}</h1>
                        <h2 class="is-family-secondary is-size-14">
                            <a href="{% url 'product:goods_detail' spu.id %}">{{ spu.title|truncatechars:10 }}...</a> 
                        </h2>
                        <div class="mt-2 foot">
                            <div class=" is-pulled-left is-size-7 has-text-grey-light">{{ sku.sales }}人付款</div>
                            <div class=" is-pulled-right is-size-7 has-text-grey-light">5.0分</div>
                            <div class="is-clearfix"></div>
                        </div>
                    </a>
                      {% endfor %}
                    {% endfor %}
                </div>
                </div>
            </div>
        </div>
    </div>
</section>

{% endblock %}


{% block vuebefy %}{{ block.super }}
    
    <script>
        // 轮播图
        var slider_image = document.querySelector("#slider-image").innerHTML;
        var slider_image_json = JSON.parse(slider_image);
        // 规格
        var specs = document.querySelector("#specs").innerHTML;
        var productAttr = JSON.parse(specs);
        // 规格对应的sku
        var spec_sku = document.querySelector("#spec-sku").innerHTML;
        var productValue = JSON.parse(spec_sku);
        
        // 获取选中有sku的options
        var keys = JSON.parse(document.querySelector("#keys").innerHTML)
        

        var product = new Vue({
            el: '#product-detail',
            // 修改Vue变量的读取语法，避免与django冲突
            delimiters: ['[[', ']]'],
            data: {
                gallery: false,
                slider: slider_image_json,
                num:1,
                productAttr: productAttr,
                productValue: productValue,
                attrSelected: [],
                attrValueSelected: null,
                // SelectedOptions: SelectedOptions,
                keys:keys,
                stock: 0,
                sales: 0,
                sell_price:0,
                market_price: 0,
            },
            methods: {
                getImgUrl(value) {
                    return `${value}`
                },
            },
            created(){ 
                // 处理单规格，即不存在规格
                if (this.productAttr.length == 0) {
                    let value = Object.values(this.productValue)[0]
                    this.stock = value.sku_stocks;
                    this.market_price = value.sku_market_price;
                    this.sell_price = value.sku_sell_price;
                    this.sales = value.sku_sales;
                }
            },

            watch: {
                productAttr: {
                    immediate: true,
                    handler(attr) {
                        attr.forEach((value, index) => {
                            // 选中第一个有可能存在sku，页面无法显示
                            // this.attrSelected[index] = value.attr_values[0];
                            this.attrSelected[index] = keys[index];
                        });
                    }
                },
                attrSelected: {
                    immediate: true,
                    handler(attr) {
                        if (attr.length) {
                            let name = attr.join(),
                            value = this.productValue[name];
                            // console.log(value)
                            if (value) {
                                this.attrValueSelected = value;
                                this.stock = value.sku_stocks;
                                this.market_price = value.sku_market_price;
                                this.sell_price = value.sku_sell_price;
                                    // this.product_unit = value.sku_product_unit;
                                this.sku_id = value.sku_id;
                                this.sales = value.sku_sales;
                                    // this.unique = value.unique;
                                } else {
                                    this.stock = 0;
                                }
                        }
                    }
                }
            },

        })
    </script>
{% endblock %}
    

