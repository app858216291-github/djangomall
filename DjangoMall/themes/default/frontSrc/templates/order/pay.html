{% extends "base.html" %}
{% load static %}

{% block title %}
  支付页面
{% endblock %}
{% block head_style %}
<link rel="stylesheet" href="{% static 'order/css/order.css' %}">
{% endblock %}

{% block breadcrumb %}
<li class="is-active"><a href=""><span>支付页</span></a></li>
{% endblock %}

{% block main %}
<div class="section" id="pay">
    <section class="container">  
        
    <form id="form" action="" method="post">
        {% csrf_token %}
        <input type="hidden" name="type" value="{{ type }}">
        <!-- 支付方式 -->
        <div class="card is-shadowless">
            <header class="card-header">
                <p class="card-header-title">
                    支付方式
                </p>
            </header>
            <div class="card-content">
                <div class="columns is-multiline">
                    {% for key, value in pay_method.items %}
                    <div class="column is-3">
                    <label class="address">
                        <input type="radio" name="pay_method" id="pay_method_{{ key }}" value="{{ key }}" {% if pay_default == key %}checked{% endif %} hidden>
                        <div class="box attr is-shadowless border has-text-centered">
                            {{ value }}
                        </div>
                    </label>
                    </div>
                    {% endfor %}
                </div>
        
            </div>
        </div>
        <!-- 支付方式 end-->

        <!-- 收货地址 -->
        <div class="card mt-3 is-shadowless">
            <header class="card-header">
                <p class="card-header-title">
                    收货地址
                </p>
            </header>
            <div class="card-content">

                <div class="columns is-multiline">
                    {% if address_list %}
                    {% for addr in address_list %}
                    <div class="column is-6">
                        <label class="address">
                            <input type="radio" name="address" id="address_{{ addr.id }}" value="{{ addr.address }}" {% if addr.is_default %}checked{% endif %} hidden>
                            <div class="box attr is-shadowless border">
                                {% if addr.is_default %}
                                <span class="tag is-primary">默认</span>
                                {% endif %}
                                {{ addr.name }}{{ addr.phone }}
                                <p class="has-text-grey-dark">
                                    {{ addr.address }}
                                </p>
                            </div>
                        </label>
                    </div>
                    {% endfor %}
                    {% endif %}
                    <div class="column is-6">
                        <a class="box has-text-grey-light has-text-centered is-shadowless" 
                            style="cursor: pointer; border: solid 1px rgb(236, 235, 235);" href="{% url 'personal:address_create' %}">
                            <div class="pt-2 pb-2">
                                <svg style="width:24px;height:24px" viewBox="0 0 24 24">
                                    <path fill="currentColor" d="M13 20H13.09A5.5 5.5 0 0 0 13.81 22H9A2 2 0 0 1 11 20V12H3.5L6 9.5L3.5 7H11V3L12 2L13 3V7H18L20.5 9.5L18 12H13M18 15V18H15V20H18V23H20V20H23V18H20V15Z" />
                                </svg>
                                <span>添加新地址</span>
                            </div>
                        </a>
                    </div> 
                </div>
            </div>
        </div>
        <!-- 收货地址 end -->

        <!-- 订单商品信息 -->
        <div class="box is-shadowless has-background-white mt-4" v-if="cartJson.length">
            <div id="cartJson" v-show='show'>{{ carts }}</div>
            <h1 class="is-size-5 mb-2">订单信息:</h1>
            <div class="box is-shadowless border mt-3">
                <div class="level" v-for="(item, index) in cartJson" :key="index">
                    <div class="level-left">
                        <div class="level-item">
                            <figure class="image">
                                <img :src="item.sku__main_picture" alt="" style="width: 100px;">
                            </figure>
                        </div>
                        <div class="level-item" style="display: block;">
                            <h1>[[ item.sku__spu__title ]]</h1>
                            <p class=" has-text-grey mt-2">[[ item.sku_options ]]</p>
                        </div>
                        
                    </div>
                    <div class="level-right">
                        <div class="level-item pr-6">
                            [[ item.num ]] x [[ item.sku__sell_price ]]
                        </div>
                        <div class="level-item pl-5">
                            <strong class="has-text-danger-dark is-size-5">[[ item.sku_total_price ]]</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="box is-shadowless has-background-white mt-4" v-else>未查询到任何商品信息，请前往选购商品！</div>
        <!-- 订单商品信息 end -->
        <div class="box has-text-right is-shadowless">
            <div class="columns">
                <div class="column is-10">
                    <ul>
                        <li>
                        共[[ cartJson.length ]] 件商品,总商品金额：</li>
                        <li>运费：</li>
                    </ul>
                </div>
                <div class="column">
                    <ul>
                        <li class=" has-text-right ">¥[[ totalPrice|numFilter ]]</li>
                        <li class=" has-text-right ">¥[[ freight|numFilter ]]</li>
                    </ul>
                </div>
            </div>

            <div class="columns has-background-light">
                <div class="column is-10">
                    <label style="line-height: 2.5em;">应付总金额：</label>
                </div>
                <div class="column">
                    <span class="is-size-4 has-text-weight-bold has-text-danger-dark">
                        ¥[[toTal]]
                    </span>
                </div>
            </div>
        </div>
        <b-field label="订单备注" :label-position="labelPosition">
            <b-input 
                maxlength="200" 
                type="textarea" 
                placeholder="有特殊要求，请务必备注说明!" 
                name="order_mark" 
                id="id_order_mark">
            </b-input>
        </b-field>
        <input class="button is-primary is-pulled-right pl-6 pr-6" type="submit" value="立即支付">
        <div class="is-clearfix"></div>
    </form>
    </section>
</div>

{% endblock %}

{% block vue_script %}
<script>
    var cartJson = JSON.parse(document.querySelector('#cartJson').innerHTML);
    // console.log(cartJson)
    var type = '{{ type }}';

    var pay = new Vue({
        el: '#pay',
        // 修改Vue变量的读取语法，避免与django冲突
        delimiters: ['[[', ']]'],
        data: {
            labelPosition: 'on-border',
            cartJson: cartJson,
            freight: 0,
            show: false,
            type: type
        },
        filters: {
            numFilter (value) {
                let realVal = ''
                if (!isNaN(value) && value!== '') {
                    // 截取当前数据到小数点后两位
                    realVal = parseFloat(value).toFixed(2)
                } else {
                    realVal = '-'
                }
                return realVal
            }
        },
        computed: {
            // 商品总价
            totalPrice: function(){
                var total = 0;
                this.cartJson.forEach((element, i, arr) => {
                    total += parseFloat(arr[i].sku_total_price)
                }) 
                return total;
            },
            // 总价
            toTal: function(){
                return (this.totalPrice + this.freight).toFixed(2);
            }
            
        },

        methods: {
            getPay(){
                console.log('ceshi')
            }
        }
        
    })
</script>
{% endblock %}